BIN_DIR := ./.bin
KUSTOMIZE_VERSION := v5.4.1
KUBEVAL_VERSION := 0.16.1

KUSTOMIZE_BIN ?= $(BIN_DIR)/kustomize
KUBEVAL_BIN ?= $(BIN_DIR)/kubeval

ENV ?= staging

INFRA_OVERLAY_DIR := infrastructure/overlays/$(ENV)
APPS_OVERLAY_DIR := applications/overlays/$(ENV)

.PHONY: all validate build diff lint clean \
        validate-infra build-infra diff-infra lint-infra \
        validate-apps build-apps diff-apps lint-apps \
        install-tools install-kustomize install-kubeval ensure-bin-dir

## Default build and validate all
all: validate build

## üß™ Validate all overlays
validate: validate-infra validate-apps

## üî® Build all overlays
build: build-infra build-apps

## üîç Diff all overlays with cluster
diff: diff-infra diff-apps

## üìã Lint all overlays
lint: lint-infra lint-apps

## üî• Clean up temp artifacts
clean:
	@echo "üßπ Cleaning up..."
	rm -rf .kustomize-tmp

## ---------------- Infrastructure ----------------

validate-infra:
	@echo "üîç Validating infrastructure for '$(ENV)'..."
	$(KUSTOMIZE_BIN) build $(INFRA_OVERLAY_DIR) >/dev/null
	@echo "‚úÖ Infrastructure validation passed"

build-infra:
	@echo "üõ†Ô∏è Building infrastructure manifest for '$(ENV)'..."
	$(KUSTOMIZE_BIN) build $(INFRA_OVERLAY_DIR)

diff-infra:
	@echo "üîé Diffing infrastructure against cluster..."
	$(KUSTOMIZE_BIN) build $(INFRA_OVERLAY_DIR) | kubectl diff -f -

lint-infra:
	@echo "üìã Linting infrastructure YAMLs with kubeval..."
	$(KUSTOMIZE_BIN) build $(INFRA_OVERLAY_DIR) | $(KUBEVAL_BIN) --strict --ignore-missing-schemas


## ---------------- Applications ----------------

validate-apps:
	@echo "üîç Validating applications for '$(ENV)'..."
	$(KUSTOMIZE_BIN) build $(APPS_OVERLAY_DIR) >/dev/null
	@echo "‚úÖ Applications validation passed"

build-apps:
	@echo "üõ†Ô∏è Building application manifest for '$(ENV)'..."
	$(KUSTOMIZE_BIN) build $(APPS_OVERLAY_DIR)

diff-apps:
	@echo "üîé Diffing applications against cluster..."
	$(KUSTOMIZE_BIN) build $(APPS_OVERLAY_DIR) | kubectl diff -f -

lint-apps:
	@echo "üìã Linting application YAMLs with kubeval..."
	$(KUSTOMIZE_BIN) build $(APPS_OVERLAY_DIR) | $(KUBEVAL_BIN) --strict --ignore-missing-schemas

## ---------------- Tooling ----------------

install-tools: install-kustomize install-kubeval

ensure-bin-dir:
	@mkdir -p $(BIN_DIR)

install-kustomize: ensure-bin-dir
	@echo "‚¨áÔ∏è  Downloading kustomize $(KUSTOMIZE_VERSION)..."
	curl -sSL https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F$(KUSTOMIZE_VERSION)/kustomize_$(KUSTOMIZE_VERSION)_linux_amd64.tar.gz \
		| tar -xz -C $(BIN_DIR)
	chmod +x $(KUSTOMIZE_BIN)

install-kubeval: ensure-bin-dir
	@echo "‚¨áÔ∏è  Downloading kubeval $(KUBEVAL_VERSION)..."
	curl -sSL https://github.com/instrumenta/kubeval/releases/download/v$(KUBEVAL_VERSION)/kubeval-linux-amd64.tar.gz \
		| tar -xz -C $(BIN_DIR)
	chmod +x $(KUBEVAL_BIN)
